vtune-profiling:
    stage: test
    tags:
    - linux
    image: python:3.10
    timeout: 2h
    variables:
        PY_VER: '3.10'
        PY_SUF: 'cp310-cp310'
    rules:
        - if: $CI_COMMIT_REF_PROTECTED == "true"
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_CUSTOM_BRANCH == "1"
        - if: $TEST_ALL_PYTHONS == "1"
    needs:
        - build-linux-3.10-valgrind
    before_script:
        - export PATH="/opt/python/$PY_SUF/bin:$PATH"
        # for gmsh
        - apt-get update -qq && apt-get install -y -qq libglu1-mesa-dev 
        - apt-get update -qq && apt-get install -y -qq libxcursor1      
        - apt-get update -qq && apt-get install -y -qq libxinerama1     
        # install intel oneapi (includes vtune) - simplified approach
        - apt-get update -qq && apt-get install -y -qq wget gpg-agent
        - wget -O- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB | gpg --dearmor | tee /usr/share/keyrings/oneapi-archive-keyring.gpg > /dev/null
        - echo "deb [signed-by=/usr/share/keyrings/oneapi-archive-keyring.gpg] https://apt.repos.intel.com/oneapi all main" | tee /etc/apt/sources.list.d/oneAPI.list
        - apt-get update -qq && apt-get install -y -qq intel-oneapi-vtune
        - export PYTHONUNBUFFERED=1
        - python -m pip install --upgrade pip
        # remove flash installed by its pipelines, and get one from pip
        - pip uninstall open-darts-flash
        - pip install --upgrade --upgrade-strategy eager ./dist/*.whl
        # setup intel oneapi environment and verify vtune installation
        - source /opt/intel/oneapi/setvars.sh
        - which vtune || echo "VTune not found in PATH"
        - vtune --version || echo "VTune version check failed"
    script:
        - echo ">>> Running VTune profiling script <<<"
        - python helper_scripts/vtune_profiling.py
    artifacts:
      paths:
        - models/_vtune_logs/*.log
        - models/_vtune_logs/*.txt
        - models/_vtune_logs/*.csv
      when: always
      expire_in: 1 week 