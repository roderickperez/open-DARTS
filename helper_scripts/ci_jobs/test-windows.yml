.test-windows:
    stage: test
    # Will be executed on runner with windows tag - that assumed to run on windows host
    tags:
        - windows-shell
    before_script:
        - $env:PATH +=";" + $env:PYTHONPATH + ";" + $env:PYTHONPATH + "\Scripts"
        # enable unbuffered output so that everything goes to log file in a correct order
        - $env:PYTHONUNBUFFERED = 1
        - $env:PYTHONLEGACYWINDOWSSTDIO = 1
        - $WHEEL_NAME=python -c "import os; print(os.listdir('dist')[0])"
        # upgrade pip package first
        - python -m pip install --upgrade pip
        # remove flash installed by its pipelines, and get one from pip
        - pip uninstall open-darts-flash  --yes
        # force reinstall of darts wheel only (need to force because darts wheel version is not incremented)
        - pip install --force-reinstall --no-deps .\dist\$WHEEL_NAME
        # force-reinstall of dependencies takes too much time, lets only upgrade (eagerly!) them
        - pip install --upgrade --upgrade-strategy eager .\dist\$WHEEL_NAME
    script:
        # run simulation fot test models set
        - cd models
        # passing additional argument to trigger verbose check performance
        - darts run_test_suite2.py LOG
        - cd ..
        # test interpolators
        - cd tests\engines\src\interpolation
        - python test_interpolation.py
        - cd ..\..\..\..
        # test discretizer
        - cd discretizer\tests\compare_discretizers
        - python main.py
        - cd ..\..\..
    after_script:
        - cd models
        - .\archive_pkl.bat $env:ODLS $env:TEST_GPU
        - cd ..
    artifacts:
      paths:
        - '.\models\_logs\*.log'
        - './models/fracture_network/meshes*/*.log'
        - './models/displaced_fault_reactivation/meshes/*.log'
        - '.\models\pkl_win.zip'
      when: always
      expire_in: 1 week

test-windows-3.12:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.12'
        PYTHONPATH: 'D:\Python312' 
        ODLS: '-a'
    needs:
        - build-windows-3.12
        
test-windows-3.11:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.11'
        PYTHONPATH: 'D:\Python311' 
        ODLS: '-a'
    needs:
        - build-windows-3.11
     
test-windows-3.10:
    rules:
        - if: $CI_COMMIT_REF_PROTECTED == "true"
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_CUSTOM_BRANCH == "1"
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.10'
        PYTHONPATH: 'D:\Python310'
        ODLS: '-a'
    needs:
        - build-windows-3.10

test-windows-3.9:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.9'
        PYTHONPATH: 'D:\Python39' 
        ODLS: '-a'
    needs:
        - build-windows-3.9

test-windows-3.12-ODLS:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.12'
        PYTHONPATH: 'D:\Python312'
        ODLS: ''
    needs:
        - build-windows-3.12-ODLS
        
test-windows-3.11-ODLS:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.11'
        PYTHONPATH: 'D:\Python311'
        ODLS: ''
    needs:
        - build-windows-3.11-ODLS
     
test-windows-3.10-ODLS:
    rules:
        - if: $CI_COMMIT_REF_PROTECTED == "true"
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_CUSTOM_BRANCH == "1"
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.10'
        PYTHONPATH: 'D:\Python310'
        ODLS: ''
    needs:
        - build-windows-3.10-ODLS

test-windows-3.9-ODLS:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.9'
        PYTHONPATH: 'D:\Python39'
        ODLS: ''
    needs:
        - build-windows-3.9-ODLS 