include conf_gcc.mk
include conf_nvcc_lisa.mk

TARGET      = ../darts-package/darts/engines.so
IFLAGS      = -I./src -I./src/interpolation -I./src/pybind11
IFLAGS      += -I./lib/darts_linear_solvers/include -I./lib/pybind11 $(PYTHON_IFLAGS)
IFLAGS_GPU  = $(IFLAGS) -I/usr/local/cuda-10.1/include -I/usr/local/cuda-10.2/include
DFLAGS      = -DPYBIND11_ENABLED -D_GLIBCXX_USE_CXX11_ABI=0
DFLAGS_GPU	= $(DFLAGS) -DWITH_GPU
LFLAGS_BASE	+= -L./lib/darts_linear_solvers/lib $(PYTHON_LFLAGS) 
LFLAGS_MT  	= $(LFLAGS_BASE) -ldarts_linear_solvers_mt
LFLAGS_GPU 	= $(LFLAGS_BASE) -ldarts_linear_solvers_gpu -lcusparse -lcublas -laips -lcusolver -lnvToolsExt -lamgx  -L../darts-linear-solvers/lib/aips/lib -L../darts-linear-solvers/lib/AMGX/build_lisa -L/usr/local/cuda-10.2/lib64
#LFLAGS_GPU 	= $(LFLAGS_BASE) -ldarts_linear_solvers_gpu -lcusparse -lcublas -lgomp
LFLAGS      = $(LFLAGS_BASE) -ldarts_linear_solvers

BUILD_DIR	= build

SUBDIRS     = interpolation pybind11 mech
BUILD_DIRS  = $(BUILD_DIR) $(patsubst %,$(BUILD_DIR)/%,$(SUBDIRS))


OBJ =  conn_mesh.o \
	engine_base.o \
	engine_nc_cg_cpu.o \
	engine_nc_cg_dif_cpu.o \
	engine_nc_cpu.o \
	engine_nc_totvelocity_cpu.o \
	engine_nc_g_cpu.o \
	engine_nce_cpu.o \
	engine_nce_g_cpu.o \
	engine_nct_cpu.o \
	engine_nct_kin_cpu.o \
	engine_nc_kin_cpu.o \
	engine_nc_mp_cpu.o \
	engine_nc_dif_cpu.o \
	engine_nc_dvelocity_cpu.o \
	engine_nce_dvelocity_cpu.o \
	engine_nc_kin_dif_cpu.o \
	engine_nc_kin_dif_np_cpu.o \
	engine_nc_sol_cpu.o \
	mech/engine_elasticity_cpu.o \
	mech/engine_nc_pm_cpu.o \
	mech/pm_discretizer.o \
	mech/mech_operators.o \
	mech/engine_pm_cpu.o \
	globals.o \
	ms_well.o \
	well_controls.o \
	stream.o \
	pybind11/py_engine_base.o \
	pybind11/py_engine_nc_cg_cpu.o \
	pybind11/py_engine_nc_cg_dif_cpu.o \
	pybind11/py_engine_nc_cpu.o \
	pybind11/py_engine_nc_totvelocity_cpu.o \
	pybind11/py_engine_nc_g_cpu.o \
	pybind11/py_engine_nc_mp_cpu.o \
	pybind11/py_engine_nce_cpu.o \
	pybind11/py_engine_nce_g_cpu.o \
	pybind11/py_engine_nct_cpu.o \
	pybind11/py_engine_nct_kin_cpu.o \
	pybind11/py_engine_nc_kin_cpu.o \
	pybind11/py_engine_nc_dif_cpu.o \
	pybind11/py_engine_nc_dvelocity_cpu.o \
	pybind11/py_engine_nce_dvelocity_cpu.o \
	pybind11/py_engine_nc_kin_dif_cpu.o \
	pybind11/py_engine_nc_kin_dif_np_cpu.o \
	pybind11/py_engine_nc_sol_cpu.o \
	pybind11/py_engine_elasticity_cpu.o \
	pybind11/py_engine_nc_pm_cpu.o \
	pybind11/py_engine_pm_cpu.o \
	pybind11/py_pm_discretizer.o \
	pybind11/py_mech_operators.o \
	pybind11/py_evaluator_iface.o \
	pybind11/py_globals.o \
	pybind11/py_main.o \
	pybind11/py_mesh_conn.o \
	pybind11/py_ms_well.o \
	pybind11/py_operator_set_interpolator_pz.o \
	pybind11/py_operator_set_interpolator_pz_cap_gra.o \
	pybind11/py_operator_set_interpolator_pz_cap_gra_dif.o \
	pybind11/py_operator_set_interpolator_pz_dif.o \
	pybind11/py_operator_set_interpolator_pz_kin.o \
	pybind11/py_operator_set_interpolator_pz_kin_phi.o \
	pybind11/py_operator_set_interpolator_pz_kin_dif.o \
	pybind11/py_operator_set_interpolator_pz_kin_dif_np.o \
	pybind11/py_operator_set_interpolator_pz_sol.o \
	pybind11/py_operator_set_interpolator_pze.o \
	pybind11/py_operator_set_interpolator_pze_dvelocity.o \
	pybind11/py_operator_set_interpolator_pze_gra.o \
	pybind11/py_operator_set_interpolator_pzt.o \
	pybind11/py_operator_set_interpolator_pzt_kin.o \
	pybind11/py_operator_set_interpolator_rates.o \
	pybind11/py_well_controls.o \
	engines_build_info.o

OBJ_GPU =  	engine_base_gpu.o \
			engine_nc_gpu.cu.o \
			engine_nc_cg_gpu.cu.o \
			engine_nce_gpu.cu.o \
			engine_nce_g_gpu.cu.o \
			engine_nc_cg_dif_gpu.cu.o \
			pybind11/py_engine_nc_gpu.o \
			pybind11/py_engine_nc_cg_gpu.o \
			pybind11/py_engine_nce_gpu.o \
			pybind11/py_engine_nc_cg_dif_gpu.o \




OBJ_D = $(patsubst %,$(BUILD_DIR)/%,$(OBJ))
OBJ_GPU_D = $(patsubst %.o,$(BUILD_DIR)/%.gpu.o,$(OBJ_GPU) $(OBJ))
OBJ_MT_D = $(patsubst %.o,$(BUILD_DIR)/%.mt.o,$(OBJ))

OBJ_DEBUG_D = $(patsubst %.o,$(BUILD_DIR)/%.od,$(OBJ))
OBJ_GPU_DEBUG_D = $(patsubst %.o,$(BUILD_DIR)/%.gpu.d.o,$(OBJ_GPU) $(OBJ))
OBJ_MT_DEBUG_D = $(patsubst %.o,$(BUILD_DIR)/%.mt.od,$(OBJ))

BUILD_MACHINE := $(shell whoami)@$(shell hostname)
BUILD_DATE := $(shell TZ=Europe/Amsterdam date +"%d/%m/%Y, %H:%M:%S")
BUILD_GIT_HASH := $(shell git describe --always --dirty --match 'NOT A TAG')

dir_guard=@mkdir -p $(@D)


default: $(TARGET)


.PHONY: gpu mt clean clean_target build_dirs build_info

# Additional rule to force rebuild build_info.cpp file every time
src/engines_build_info.cpp: build_info
	$(shell echo "#include \"engines_build_info.h\""  > src/engines_build_info.cpp)
	$(shell echo "const char *ENGINES_BUILD_DATE = \"$(BUILD_DATE)\";"  >> src/engines_build_info.cpp)
	$(shell echo "const char *ENGINES_BUILD_MACHINE = \"$(BUILD_MACHINE)\";"  >> src/engines_build_info.cpp)
	$(shell echo "const char *ENGINES_BUILD_GIT_HASH = \"$(BUILD_GIT_HASH)\";"  >> src/engines_build_info.cpp)
	cat src/engines_build_info.cpp

.PHONY: gpu mt debug gpu_debug mt_debug clean clean_target build_dirs 

build_dirs: $(BUILD_DIRS)

$(BUILD_DIRS):
	mkdir -p $@


$(BUILD_DIR)/%.o:          src/%.cpp
	$(CXX) $(CXXFLAGS) $(IFLAGS) $(DFLAGS)  -c -o  $@ $<

# template class instantiation (for interpolators, for example) has been moved to expose functions
# in order to simplify and generalize the code. So *.cu do not exist anymore
# consequently, for GPU build those py_*.cpp files which expose gpu classes have to be compiled by nvcc
# the simpliest solution is to compile all cpp files by nvcc using --x=cu
$(BUILD_DIR)/%.gpu.o:          src/%.cpp
	$(NVCC) $(NVCCFLAGS) --x=cu $(IFLAGS_GPU) $(DFLAGS_GPU) -c -o  $@ $<

$(BUILD_DIR)/%.cu.gpu.o:          src/%.cu
	$(NVCC) $(NVCCFLAGS) $(IFLAGS_GPU) $(DFLAGS_GPU) -c -o  $@ $<
	
$(BUILD_DIR)/%.mt.o:          src/%.cpp
	$(CXX) $(CXXFLAGS) $(OMP_FLAG) $(IFLAGS) $(DFLAGS)  -c -o  $@ $<

$(BUILD_DIR)/%.od:          src/%.cpp
	$(CXX) $(CXXFLAGS_DEBUG) $(IFLAGS) $(DFLAGS)  -c -o  $@ $<

$(BUILD_DIR)/%.gpu.d.o:          src/%.cpp
	$(CXX) $(CXXFLAGS_DEBUG) $(IFLAGS_GPU) $(DFLAGS_GPU)  -c -o  $@ $<

$(BUILD_DIR)/%.cu.gpu.d.o:          src/%.cu
	$(NVCC) $(NVCCFLAGS_DEBUG) $(IFLAGS_GPU) $(DFLAGS_GPU) -c -o  $@ $<
	
$(BUILD_DIR)/%.mt.od:          src/%.cpp
	$(CXX) $(CXXFLAGS_DEBUG) $(OMP_FLAG) $(IFLAGS) $(DFLAGS)  -c -o  $@ $<



$(TARGET): build_dirs $(OBJ_D) $(LIN_LIB)
	$(CXX) -shared -o $(TARGET) $(OBJ_D) $(LFLAGS)

gpu: build_dirs $(OBJ_GPU_D) $(LIN_LIB)
	$(NVCC) -shared -o $(TARGET) $(OBJ_GPU_D) $(LFLAGS_GPU)

mt: build_dirs $(OBJ_MT_D) $(LIN_LIB)
	$(CXX) -shared -o $(TARGET) $(OBJ_MT_D) $(LFLAGS_MT) $(OMP_FLAG)

debug: build_dirs $(OBJ_DEBUG_D) $(LIN_LIB)
	$(CXX) -shared -o $(TARGET) $(OBJ_DEBUG_D) $(LFLAGS)

gpu_debug: build_dirs $(OBJ_GPU_DEBUG_D) $(LIN_LIB)
	$(NVCC) -shared -o $(TARGET) $(OBJ_GPU_DEBUG_D) $(LFLAGS_GPU)

mt_debug: build_dirs $(OBJ_MT_DEBUG_D) $(LIN_LIB)
	$(CXX) -shared -o $(TARGET) $(OBJ_MT_DEBUG_D) $(LFLAGS_MT)



clean:
	rm -rf $(TARGET) $(OBJ_D) $(OBJ_MT_D) $(OBJ_GPU_D) $(OBJ_DEBUG_D) $(OBJ_MT_DEBUG_D) $(OBJ_GPU_DEBUG_D)

clean_target:
	rm -rf $(TARGET)