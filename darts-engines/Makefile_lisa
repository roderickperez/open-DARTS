include conf_gcc.mk
include conf_nvcc_lisa.mk

TARGET      = ../darts-package/darts/engines.so
IFLAGS      = -I./src -I./src/interpolation -I./src/pybind11
IFLAGS      += -I./lib/darts_linear_solvers/include -I./lib/pybind11 $(PYTHON_IFLAGS)
IFLAGS_GPU  = $(IFLAGS) -I/usr/local/cuda-10.1/include
DFLAGS      = -DPYBIND11_ENABLED -D_GLIBCXX_USE_CXX11_ABI=0
DFLAGS_GPU	= $(DFLAGS) -DWITH_GPU
LFLAGS_BASE	+= -L./lib/darts_linear_solvers/lib $(PYTHON_LFLAGS) 
LFLAGS_MT  	= $(LFLAGS_BASE) -ldarts_linear_solvers_mt
LFLAGS_GPU 	= $(LFLAGS_BASE) -ldarts_linear_solvers_gpu -lcusparse -lcublas -laips -lcusolver -lnvToolsExt -lamgx  -L../darts-linear-solvers/lib/aips/lib -L../darts-linear-solvers/lib/AMGX/build_lisa
#LFLAGS_GPU 	= $(LFLAGS_BASE) -ldarts_linear_solvers_gpu -lcusparse -lcublas -lgomp
LFLAGS      = $(LFLAGS_BASE) -ldarts_linear_solvers

BUILD_DIR	= build

SUBDIRS     = interpolation pybind11 mech
BUILD_DIRS  = $(BUILD_DIR) $(patsubst %,$(BUILD_DIR)/%,$(SUBDIRS))


OBJ =  conn_mesh.o \
	engine_base.o \
	engine_nc_cg_cpu.o \
	engine_nc_cg_dif_cpu.o \
	engine_nc_cpu.o \
	engine_nc_g_cpu.o \
	engine_nce_cpu.o \
	engine_nce_g_cpu.o \
	engine_nct_cpu.o \
	engine_nc_kin_cpu.o \
	engine_nc_dif_cpu.o \
	engine_nc_kin_dif_cpu.o \
	globals.o \
	ms_well.o \
	well_controls.o \
	interpolation/operator_set_from_files.o \
	interpolation/operator_set_interpolator_static.o \
	stream.o \
	pybind11/py_engine_base.o \
	pybind11/py_engine_nc_cg_cpu.o \
	pybind11/py_engine_nc_cg_dif_cpu.o \
	pybind11/py_engine_nc_cpu.o \
	pybind11/py_engine_nc_g_cpu.o \
	pybind11/py_engine_nce_cpu.o \
	pybind11/py_engine_nce_g_cpu.o \
	pybind11/py_engine_nct_cpu.o \
	pybind11/py_engine_nc_kin_cpu.o \
	pybind11/py_engine_nc_dif_cpu.o \
	pybind11/py_engine_nc_kin_dif_cpu.o \
	pybind11/py_evaluator_iface.o \
	pybind11/py_globals.o \
	pybind11/py_main.o \
	pybind11/py_mesh_conn.o \
	pybind11/py_ms_well.o \
	pybind11/py_operator_set_from_files.o \
	pybind11/py_operator_set_interpolator_pz.o \
	pybind11/py_operator_set_interpolator_pz_cap_gra.o \
	pybind11/py_operator_set_interpolator_pz_cap_gra_dif.o \
	pybind11/py_operator_set_interpolator_pz_dif.o \
	pybind11/py_operator_set_interpolator_pz_kin.o \
	pybind11/py_operator_set_interpolator_pz_kin_phi.o \
	pybind11/py_operator_set_interpolator_pz_kin_dif.o \
	pybind11/py_operator_set_interpolator_pze.o \
	pybind11/py_operator_set_interpolator_pze_gra.o \
	pybind11/py_operator_set_interpolator_pzt.o \
	pybind11/py_operator_set_interpolator_rates.o \
	pybind11/py_operator_set_interpolator_static.o \
	pybind11/py_well_controls.o

OBJ_GPU =  	interpolation/operator_set_interpolator_gpu.cu.o \
			pybind11/py_operator_set_interpolator_gpu.o \
			engine_base_gpu.o \
			engine_nc_gpu.cu.o \
			engine_nc_cg_gpu.cu.o \
			engine_nce_gpu.cu.o \
			pybind11/py_engine_nc_gpu.o \
			pybind11/py_engine_nc_cg_gpu.o \
			pybind11/py_engine_nce_gpu.o \




OBJ_D = $(patsubst %,$(BUILD_DIR)/%,$(OBJ))
OBJ_GPU_D = $(patsubst %.o,$(BUILD_DIR)/%.gpu.o,$(OBJ_GPU) $(OBJ))
OBJ_MT_D = $(patsubst %.o,$(BUILD_DIR)/%.mt.o,$(OBJ))

OBJ_DEBUG_D = $(patsubst %.o,$(BUILD_DIR)/%.d.o,$(OBJ))
OBJ_GPU_DEBUG_D = $(patsubst %.o,$(BUILD_DIR)/%.gpu.d.o,$(OBJ_GPU) $(OBJ))
OBJ_MT_DEBUG_D = $(patsubst %.o,$(BUILD_DIR)/%.mt.od,$(OBJ))

dir_guard=@mkdir -p $(@D)


default: $(TARGET)


.PHONY: gpu mt gpu_debug clean clean_target build_dirs 

build_dirs: $(BUILD_DIRS)

$(BUILD_DIRS):
	mkdir -p $@


$(BUILD_DIR)/%.o:          src/%.cpp
	$(CXX) $(CXXFLAGS) $(IFLAGS) $(DFLAGS)  -c -o  $@ $<

$(BUILD_DIR)/%.gpu.o:          src/%.cpp
	$(CXX) $(CXXFLAGS) $(IFLAGS_GPU) $(DFLAGS_GPU)  -c -o  $@ $<

$(BUILD_DIR)/%.cu.gpu.o:          src/%.cu
	$(NVCC) $(NVCCFLAGS) $(IFLAGS_GPU) $(DFLAGS_GPU) -c -o  $@ $<
	
$(BUILD_DIR)/%.mt.o:          src/%.cpp
	$(CXX) $(CXXFLAGS) $(OMP_FLAG) $(IFLAGS) $(DFLAGS)  -c -o  $@ $<

$(BUILD_DIR)/%.od:          src/%.cpp
	$(CXX) $(CXXFLAGS_DEBUG) $(IFLAGS) $(DFLAGS)  -c -o  $@ $<

$(BUILD_DIR)/%.gpu.d.o:          src/%.cpp
	$(CXX) $(CXXFLAGS_DEBUG) $(IFLAGS_GPU) $(DFLAGS_GPU)  -c -o  $@ $<

$(BUILD_DIR)/%.cu.gpu.d.o:          src/%.cu
	$(NVCC) $(NVCCFLAGS_DEBUG) $(IFLAGS_GPU) $(DFLAGS_GPU) -c -o  $@ $<
	
$(BUILD_DIR)/%.mt.od:          src/%.cpp
	$(CXX) $(CXXFLAGS_DEBUG) $(OMP_FLAG) $(IFLAGS) $(DFLAGS)  -c -o  $@ $<



$(TARGET): build_dirs $(OBJ_D) $(LIN_LIB)
	$(CXX) -shared -o $(TARGET) $(OBJ_D) $(LFLAGS)

gpu: build_dirs $(OBJ_GPU_D) $(LIN_LIB)
	$(NVCC) -shared -o $(TARGET) $(OBJ_GPU_D) $(LFLAGS_GPU)

mt: build_dirs $(OBJ_MT_D) $(LIN_LIB)
	$(CXX) -shared -o $(TARGET) $(OBJ_MT_D) $(LFLAGS_MT) $(OMP_FLAG)

debug: build_dirs $(OBJ_DEBUG_D) $(LIN_LIB)
	$(CXX) -shared -o $(TARGET) $(OBJ_DEBUG_D) $(LFLAGS)

gpu_debug: build_dirs $(OBJ_GPU_DEBUG_D) $(LIN_LIB)
	$(NVCC) -shared -o $(TARGET) $(OBJ_GPU_DEBUG_D) $(LFLAGS_GPU)

mt_debug: build_dirs $(OBJ_MT_DEBUG_D) $(LIN_LIB)
	$(CXX) -shared -o $(TARGET) $(OBJ_MT_DEBUG_D) $(LFLAGS_MT)



clean:
	rm -rf $(TARGET) $(OBJ_D) $(OBJ_MT_D) $(OBJ_GPU_D) $(OBJ_DEBUG_D) $(OBJ_MT_DEBUG_D) $(OBJ_GPU_DEBUG_D)

clean_target:
	rm -rf $(TARGET)
