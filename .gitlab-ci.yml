stages:
    - build images
    - build
    - test
    - deploy

###################################################################################
build-linux-3.12:
    rules: 
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1" 
    extends: .build-linux-dockcross
    variables:
        PY_VER: '3.12'        # for python image selection in .build-linux
        PY_SUF: 'cp312-cp312' # for python path selection in .build-linux-dockcross
        ODLS: '-a'

build-linux-3.11:
    rules: 
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1" 
    extends: .build-linux-dockcross
    variables:
        PY_VER: '3.11'        # for python image selection in .build-linux
        PY_SUF: 'cp311-cp311' # for python path selection in .build-linux-dockcross
        ODLS: '-a'

#build-linux-3.10:
#    rules:
#        - if: $CI_COMMIT_REF_PROTECTED == "true"
#        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
#        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
#        - if: $TEST_CUSTOM_BRANCH == "1"
#        - if: $TEST_ALL_PYTHONS == "1"
#    extends: .build-linux-dockcross
#    variables:
#        PY_VER: '3.10'        # for python image selection in .build-linux
#        PY_SUF: 'cp310-cp310' # for python path selection in .build-linux-dockcross
#        ODLS: '-a'
        
build-linux-3.9: 
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1" 
    extends: .build-linux-dockcross
    variables:
        PY_VER: '3.9'       # for python image selection in .build-linux
        PY_SUF: 'cp39-cp39' # for python path selection in .build-linux-dockcross
        ODLS: '-a'

#build-linux-3.10-gpu:
#    rules:
#        - if: $CI_COMMIT_REF_PROTECTED == "true"
#        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
#        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
#        - if: $TEST_CUSTOM_BRANCH == "1"
#        - if: $TEST_GPU_LINUX == "1"
#    extends: .build-linux-gpu
#    variables:
#        GIT_SUBMODULE_STRATEGY: recursive
#        PY_VER: '3.10'       # for python image selection in .build-linux
#        ODLS: '-a'
#        TEST_GPU: '1'

###################################################################################
build-linux-3.12-ODLS:
    rules: 
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .build-linux-dockcross
    variables:
        PY_VER: '3.12'        # for python image selection in .build-linux
        PY_SUF: 'cp312-cp312' # for python path selection in .build-linux-dockcross
        ODLS: ''              # build with open-darts linear solvers
        
build-linux-3.11-ODLS:
    rules: 
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .build-linux-dockcross
    variables:
        PY_VER: '3.11'        # for python image selection in .build-linux
        PY_SUF: 'cp311-cp311' # for python path selection in .build-linux-dockcross
        ODLS: ''              # build with open-darts linear solvers
        
#build-linux-3.10-ODLS:
#    rules:
#        - if: $CI_COMMIT_REF_PROTECTED == "true"
#        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
#        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
#        - if: $TEST_CUSTOM_BRANCH == "1"
#        - if: $TEST_ALL_PYTHONS == "1"
#    extends: .build-linux-dockcross
#    variables:
#        PY_VER: '3.10'        # for python image selection in .build-linux
#        PY_SUF: 'cp310-cp310' # for python path selection in .build-linux-dockcross
#        ODLS: ''              # build with open-darts linear solvers
        
build-linux-3.9-ODLS:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .build-linux-dockcross
    variables:
        PY_VER: '3.9'        # for python image selection in .build-linux
        PY_SUF: 'cp39-cp39'  # for python path selection in .build-linux-dockcross
        ODLS: ''             # build with open-darts linear solvers

###################################################################################

build-linux-3.10-valgrind:
    stage: build
    tags:
        - linux
    rules:
#        - if: $TEST_VALGRIND == "1"
        - if: $CI_COMMIT_REF_PROTECTED == "true"
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_CUSTOM_BRANCH == "1"
        - if: $TEST_ALL_PYTHONS == "1"   
    extends: .build-linux-dockcross
    variables:
        PY_VER: '3.10'
        PY_SUF: 'cp310-cp310'
        ODLS: '-a'
        CMAKE_ARGS: "-DENABLE_VALGRIND=ON"
    script:
        - echo ">>> Starting debug build (valgrind instrumentation) <<<"
        # Pass CMAKE_ARGS through to your helper script (adjust as needed)
        - ./helper_scripts/build_darts_cmake.sh \
            -c -w -t -m -j 8 $ODLS \
            -DCMAKE_BUILD_TYPE=Debug $CMAKE_ARGS
    artifacts:
      paths:
        - './dist/*.whl'
        - '*.log'
      expire_in: 1 week
      when: always
        
###################################################################################
build-windows-3.12:
    rules: 
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .build-windows
    variables:
        PY_VER: '3.12'
        PYTHONPATH: 'D:\Python312'        
        ODLS: '-a' 
        
build-windows-3.11:
    rules: 
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .build-windows
    variables:
        PY_VER: '3.11'
        PYTHONPATH: 'D:\Python311'        
        ODLS: '-a' 

#build-windows-3.10:
#    rules:
#        - if: $CI_COMMIT_REF_PROTECTED == "true"
#        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
#        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
#        - if: $TEST_CUSTOM_BRANCH == "1"
#        - if: $TEST_ALL_PYTHONS == "1"
#    extends: .build-windows
#    variables:
#        PY_VER: '3.10'
#        PYTHONPATH: 'D:\Python310'
#        ODLS: '-a'
 
build-windows-3.9:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .build-windows
    variables:
        PY_VER: '3.9'
        PYTHONPATH: 'D:\Python39'        
        ODLS: '-a'
        
###################################################################################
build-windows-3.12-ODLS:
    rules: 
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .build-windows
    variables:
        PY_VER: '3.12'
        PYTHONPATH: 'D:\Python312'        
        ODLS: ''         # build with open-darts linear solvers
         
build-windows-3.11-ODLS:
    rules: 
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .build-windows
    variables:
        PY_VER: '3.11'
        PYTHONPATH: 'D:\Python311'        
        ODLS: ''         # build with open-darts linear solvers
                
#build-windows-3.10-ODLS:
#    rules:
#        - if: $CI_COMMIT_REF_PROTECTED == "true"
#        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
#        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
#        - if: $TEST_CUSTOM_BRANCH == "1"
#        - if: $TEST_ALL_PYTHONS == "1"
#    extends: .build-windows
#    variables:
#        PY_VER: '3.10'
#        PYTHONPATH: 'D:\Python310'
#        ODLS: ''         # build with open-darts linear solvers
                
 
build-windows-3.9-ODLS:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .build-windows
    variables:
        PY_VER: '3.9'
        PYTHONPATH: 'D:\Python39'        
        ODLS: ''         # build with open-darts linear solvers

###################################################################################

.build-linux-dockcross:
    extends: .build-linux
    # Dockcross is an image specifically made for building Python wheels, based on CentOS 7 with old glibc - it will run on even old systems
    image: "${CI_REGISTRY_IMAGE}/linux-builder"
    # Install samba client to upload build results to shared folder TODO remove
    before_script:
        - sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
        - sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*
        - yum install samba-client -y -q
        - export PATH="/opt/python/$PY_SUF/bin:$PATH"
        
###################################################################################
     
.build-linux:
    stage: build
    image: "python:$PY_VER"
    # Will be executed on runner with linux tag - that assumed to run on linux host
    tags:
        - linux
    before_script:
        - echo 'before build-linux'
        - apt-get update -qq && apt-get install -y -qq smbclient
        - export PY_SUFFIX=`python -c "import importlib.machinery; print(importlib.machinery.EXTENSION_SUFFIXES[0])"`
        - pip install wheel
    script:
        - echo "build *.so on linux started with ODLS=$ODLS"
        - ./helper_scripts/build_darts_cmake.sh -c -w -t -m -j 8 $ODLS
    artifacts:
      paths:
        - './dist/*.whl'
        - '*.log'
      expire_in: 1 week
      when: always

docker-image-builder:
  stage: build images
  tags:
    - linux
  image: 
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - /kaniko/executor 
      --context "${CI_PROJECT_DIR}/.cicd/build-linux"
      --dockerfile "${CI_PROJECT_DIR}/.cicd/build-linux/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}/linux-builder:${CI_COMMIT_TAG}"
  rules:
    - if: $UPDATE_DOCKER_IMAGE == "1"
    #- changes:
    #    - .cicd/build-linux/Dockerfile
    #    - .cicd/build-linux/Toolchain.cmake
      
###################################################################################
     
.build-linux-gpu:
    stage: build

    tags:
        - linux_gpu
    before_script:
        - module load cuda/23.5
        - source /oahu/data/open-darts-gitlab-runner-data/anaconda3/bin/activate
        - conda create -n darts_gitlab_gpu_build python=${PY_VER} --yes
        - conda activate darts_gitlab_gpu_build
    script:
        - echo "build *.so on linux GPU started with ODLS=$ODLS"
        - ./helper_scripts/build_install_darts_gpu.sh -c
    artifacts:
      paths:
        - './dist/*.whl'
        - '*.log'
      expire_in: 1 day
      when: always
      
###################################################################################

.build-windows:
    stage: build
    # Will be executed on runner with windows shell tag - that assumed to run on windows host with shell executor
    tags: 
        - windows-shell
    script:
        # Load MS Build Tools environment to the powershell
        - D:\BuildTools\build_vars.ps1
        # Add python folder to PATH
        - $env:PATH +=";" + $env:PYTHONPATH + ";" + $env:PYTHONPATH + "\Scripts"
        - $env:PY_SUFFIX=python.exe -c "import importlib.machinery; print(importlib.machinery.EXTENSION_SUFFIXES[0])"
        # make sure wheel package could be installed
        - pip install wheel
        # copy VS redist libraries 
        - copy $env:VCToolsRedistDir\x64\Microsoft.VC143.CRT\msvcp140.dll .\darts
        - copy $env:VCToolsRedistDir\x64\Microsoft.VC143.CRT\vcruntime140.dll .\darts
        - copy $env:VCToolsRedistDir\x64\Microsoft.VC143.OpenMP\vcomp140.dll .\darts
        - echo "ODLS:" $env:ODLS
        # compile and make the wheel
        - .\helper_scripts\build_darts_cmake.bat $env:ODLS -c -w -t -j 8
    artifacts:
      paths:
        - '*.log'
        - '.\dist\*.whl'
      expire_in: 1 week
      when: always

###################################################################################
test-linux-3.12-ODLS:
    rules: 
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-linux
    variables:
        PY_VER: '3.12'        # for python image selection in .test-linux
        PY_SUF: 'cp312-cp312' # for python path selection in .test-linux
        ODLS: ''              # test with open-darts linear solvers
    dependencies:
        - build-linux-3.12-ODLS
        
test-linux-3.11-ODLS:
    rules: 
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-linux
    variables:
        PY_VER: '3.11'        # for python image selection in .test-linux
        PY_SUF: 'cp311-cp311' # for python path selection in .test-linux
        ODLS: ''              # test with open-darts linear solvers
    dependencies:
        - build-linux-3.11-ODLS

#test-linux-3.10-ODLS:
#    rules:
#        - if: $CI_COMMIT_REF_PROTECTED == "true"
#        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
#        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
#        - if: $TEST_CUSTOM_BRANCH == "1"
#        - if: $TEST_ALL_PYTHONS == "1"
#    extends: .test-linux
#    variables:
#        PY_VER: '3.10'        # for python image selection in .test-linux
#        PY_SUF: 'cp310-cp310' # for python path selection in .test-linux
#        ODLS: ''              # test with open-darts linear solvers
#    dependencies:
#        - build-linux-3.10-ODLS

test-linux-3.9-ODLS:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-linux
    variables:
        PY_VER: '3.9'       # for python image selection in .test-linux
        PY_SUF: 'cp39-cp39' # for python path selection in .test-linux
        ODLS: ''            # test with open-darts linear solvers
    dependencies:
        - build-linux-3.9-ODLS

###################################################################################
test-linux-3.12:
    rules: 
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-linux
    variables:
        PY_VER: '3.12'        # for python image selection in .test-linux
        PY_SUF: 'cp312-cp312' # for python path selection in .test-linux
        ODLS: '-a'
    dependencies:
        - build-linux-3.12
        
test-linux-3.11:
    rules: 
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-linux
    variables:
        PY_VER: '3.11'        # for python image selection in .test-linux
        PY_SUF: 'cp311-cp311' # for python path selection in .test-linux
        ODLS: '-a'
    dependencies:
        - build-linux-3.11

#test-linux-3.10:
#    rules:
#        - if: $CI_COMMIT_REF_PROTECTED == "true"
#        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
#        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
#        - if: $TEST_CUSTOM_BRANCH == "1"
#        - if: $TEST_ALL_PYTHONS == "1"
#    extends: .test-linux
#    variables:
#        PY_VER: '3.10'        # for python image selection in .test-linux
#        PY_SUF: 'cp310-cp310' # for python path selection in .test-linux
#        ODLS: '-a'
#    dependencies:
#        - build-linux-3.10

test-linux-3.9:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-linux
    variables:
        PY_VER: '3.9'       # for python image selection in .test-linux
        PY_SUF: 'cp39-cp39' # for python path selection in .test-linux
        ODLS: '-a'
    dependencies:
        - build-linux-3.9

###################################################################################

#test-linux-3.10-gpu:
#    rules:
#        - if: $CI_COMMIT_REF_PROTECTED == "true"
#        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
#        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
#        - if: $TEST_CUSTOM_BRANCH == "1"
#        - if: $TEST_GPU_LINUX == "1"
#    extends: .test-linux-gpu
#    variables:
#        PY_VER: '3.10'
#        ODLS: '-a'
#        TEST_GPU: '1'
#    dependencies:
#        - build-linux-3.10-gpu
      
###################################################################################
test-windows-3.12:
    rules: 
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.12'
        PYTHONPATH: 'D:\Python312' 
        ODLS: '-a'
    dependencies:
        - build-windows-3.12
        
test-windows-3.11:
    rules: 
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.11'
        PYTHONPATH: 'D:\Python311' 
        ODLS: '-a'
    dependencies:
        - build-windows-3.11
     
#test-windows-3.10:
#    rules:
#        - if: $CI_COMMIT_REF_PROTECTED == "true"
#        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
#        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
#        - if: $TEST_CUSTOM_BRANCH == "1"
#        - if: $TEST_ALL_PYTHONS == "1"
#    extends: .test-windows
#    variables:
#        PY_VER: '3.10'
#        PYTHONPATH: 'D:\Python310'
#        ODLS: '-a'
#    dependencies:
#        - build-windows-3.10

test-windows-3.9:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.9'
        PYTHONPATH: 'D:\Python39' 
        ODLS: '-a'
    dependencies:
        - build-windows-3.9

###################################################################################
test-windows-3.12-ODLS:
    rules: 
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.12'
        PYTHONPATH: 'D:\Python312'
        ODLS: ''
    dependencies:
        - build-windows-3.12-ODLS
        
test-windows-3.11-ODLS:
    rules: 
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.11'
        PYTHONPATH: 'D:\Python311'
        ODLS: ''
    dependencies:
        - build-windows-3.11-ODLS
     
#test-windows-3.10-ODLS:
#    rules:
#        - if: $CI_COMMIT_REF_PROTECTED == "true"
#        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
#        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
#        - if: $TEST_CUSTOM_BRANCH == "1"
#        - if: $TEST_ALL_PYTHONS == "1"
#    extends: .test-windows
#    variables:
#        PY_VER: '3.10'
#        PYTHONPATH: 'D:\Python310'
#        ODLS: ''
#    dependencies:
#        - build-windows-3.10-ODLS

test-windows-3.9-ODLS:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL_PYTHONS == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.9'
        PYTHONPATH: 'D:\Python39'
        ODLS: ''
    dependencies:
        - build-windows-3.9-ODLS

###################################################################################

.test-linux:
    stage: test
    image: "python:$PY_VER"
    # Will be executed on runner with linux tag - that assumed to run on linux host
    tags:
        - linux
    before_script:
        - apt-get update -qq && apt-get install -y -qq smbclient
        - apt-get update -qq && apt-get install -y -qq libglu1-mesa-dev # for gmsh
        - apt-get update -qq && apt-get install -y -qq libxcursor1      # for gmsh
        - apt-get update -qq && apt-get install -y -qq libxinerama1     # for gmsh
        - export PYTHONUNBUFFERED=1
        # upgrade pip package first
        - python -m pip install --upgrade pip
        - pip install sympy  # for models\1ph_1comp_poroelastic_convergence
        - ls ./dist/*
        # force reinstall of darts wheel only (need to force because darts wheel version is not incremented)
        # note: need to force here only for Windows actually, but lets be consistent and force for Linux too in case its behaviour will change
        - pip install --force-reinstall --no-deps ./dist/*.whl
        # force-reinstall of dependencies takes too much time, lets only upgrade (eagerly!) them
        - pip install --upgrade --upgrade-strategy eager ./dist/*.whl
    script:
        # run simulation fot test models set
        - cd models
        # passing additional argument to trigger verbose check performance
        - darts run_test_suite2.py LOG
        - echo "run_test_suite2 returned" $?
        - cd ..
        # test interpolators
        - cd tests/engines/src/interpolation
        - darts test_interpolation.py
        - cd ../../../..
        # test discretizer
        - cd discretizer/tests/compare_discretizers
        - darts main.py
        - cd ../../..
        #
        - echo "test finished"
    after_script:
        - cd models
        - ./archive_pkl.sh $ODLS $TEST_GPU
        - cd ..
    artifacts:
      paths:
        - './models/_logs/*.log'
        - './models/pkl_lin.tar.gz'
      when: always
      expire_in: 1 week

###################################################################################

.test-linux-gpu:
    stage: test

    tags:
        - linux_gpu
    before_script:
        - module load cuda/23.5
        - source /oahu/data/open-darts-gitlab-runner-data/anaconda3/bin/activate
        - conda create -n darts_gitlab_gpu_test python=${PY_VER} --yes 
        - conda activate darts_gitlab_gpu_test
        # upgrade pip package first
        - python -m pip install --upgrade pip
        - pip install sympy  # for models\1ph_1comp_poroelastic_convergence
        - pip install ./dist/*.whl
    script:
        # run simulation fot test models set
        - cd models
        # passing additional argument LOG to trigger verbose check performance
        - systemd-run --scope -p MemoryMax=30000M -p MemoryHigh=20000M --user  darts run_test_suite2.py LOG
        - echo "run_test_suite2 returned" $?
        - cd ..
        # test discretizer
        - cd discretizer/tests/compare_discretizers
        - python main.py
        - cd ../../..
        #
        - echo "test finished"
    after_script:
        - cd models
        - ./archive_pkl.sh $ODLS $TEST_GPU
        - cd ..
    artifacts:
      paths:
        - './models/_logs/*.log'
        - './models/pkl_lin.tar.gz'
      expire_in: 1 day
      when: always
      
###################################################################################

.test-windows:
    stage: test
    # Will be executed on runner with windows tag - that assumed to run on windows host
    tags:
        - windows-shell
    before_script:
        - $env:PATH +=";" + $env:PYTHONPATH + ";" + $env:PYTHONPATH + "\Scripts"
        # enable unbuffered output so that everything goes to log file in a correct order
        - $env:PYTHONUNBUFFERED = 1
        - $env:PYTHONLEGACYWINDOWSSTDIO = 1
        - $WHEEL_NAME=python -c "import os; print(os.listdir('dist')[0])"
        # upgrade pip package first
        - python -m pip install --upgrade pip
        - pip install sympy  # for models\1ph_1comp_poroelastic_convergence
        # force reinstall of darts wheel only (need to force because darts wheel version is not incremented)
        - pip install --force-reinstall --no-deps .\dist\$WHEEL_NAME
        # force-reinstall of dependencies takes too much time, lets only upgrade (eagerly!) them
        - pip install --upgrade --upgrade-strategy eager .\dist\$WHEEL_NAME
    script:
        # run simulation fot test models set
        - cd models
        # passing additional argument to trigger verbose check performance
        - darts run_test_suite2.py LOG
        - cd ..
        # test interpolators
        - cd tests\engines\src\interpolation
        - python test_interpolation.py
        - cd ..\..\..\..
        # test discretizer
        - cd discretizer\tests\compare_discretizers
        - python main.py
        - cd ..\..\..
    after_script:
        - cd models
        - .\archive_pkl.bat $env:ODLS $env:TEST_GPU
        - cd ..
    artifacts:
      paths:
        - '.\models\_logs\*.log'
        - '.\models\pkl_win.zip'
      when: always
      expire_in: 1 week

################################################################################

valgrind-profiling:
    stage: test
    extends: .build-linux-dockcross
    rules:
    # - if: $TEST_VALGRIND == "1"
        - if: $CI_COMMIT_REF_PROTECTED == "true"
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_CUSTOM_BRANCH == "1"
        - if: $TEST_ALL_PYTHONS == "1"
    dependencies:
        - build-linux-3.10-valgrind
    before_script:
        - export PYTHONMALLOC=malloc
        # Make sure valgrind is installed
        - yum install -y -q valgrind
        - export PYTHONUNBUFFERED=1
        # upgrade pip package first
        - python -m pip install --upgrade pip
        - pip install sympy  # for models\1ph_1comp_poroelastic_convergence
        - ls ./dist/*
        # force reinstall of darts wheel only (need to force because darts wheel version is not incremented)
        # note: need to force here only for Windows actually, but lets be consistent and force for Linux too in case its behaviour will change
        - pip install --force-reinstall --no-deps ./dist/*.whl
        # force-reinstall of dependencies takes too much time, lets only upgrade (eagerly!) them
        - pip install --upgrade --upgrade-strategy eager ./dist/*.whl 
    script:
        - echo ">>> Running Valgrind profiling script <<<"
        - python helper_scripts/valgrind_profile.py
    artifacts:
      paths:
        - models/valgrind_logs/*.log
        - models/valgrind_logs/*.txt
      when: always
      expire_in: 1 week

###################################################################################

#upload_wheels:
#    stage: deploy
#    image: python:3.10
#    rules:
#        - if: $UPLOAD_WHEELS == "1"
#    tags:
#        - linux
#    before_script:
#        - apt-get update -qq && apt-get install -y -qq smbclient
#    script:
#        - ./helper_scripts/rename_whls.sh # rename linux whls to make uploadable to test-pypi
#        - export wheel=`ls ./dist/*linux*`
#        - smbclient -U $SMBLOGIN%$SMBPASS //$SMBNAME/darts-private-artifacts -c "put $wheel" -D=wheels_iter
#        - export wheel=`ls ./dist/*win*`
#        - smbclient -U $SMBLOGIN%$SMBPASS //$SMBNAME/darts-private-artifacts -c "put $wheel" -D=wheels_iter
#    dependencies:
#        # get the wheels from the build stage
#        - build-linux-3.10
#        - build-windows-3.10

#upload_wheels_gse:
#    stage: deploy
#    image: python:3.10
#    rules:
#        - if: $UPLOAD_WHEELS == "1"
#    tags:
#        - linux_gpu
#    script:
#        - ./helper_scripts/rename_whls.sh # rename linux whls to make uploadable to test-pypi
#        - export wheel=`ls ./dist/*linux*`
#        - cp $wheel $GSEWHEELSPATH
#    dependencies:
#        # get the wheels from the build stage
#        - build-linux-3.10-gpu

#upload_wheels_odls:
#    stage: deploy
#    image: python:3.10
#    rules:
#        - if: $UPLOAD_WHEELS == "1"
#    tags:
#        - linux
#    before_script:
#        - apt-get update -qq && apt-get install -y -qq smbclient
#    script:
#        - ./helper_scripts/rename_whls.sh # rename linux whls to make uploadable to test-pypi
#        - export wheel=`ls ./dist/*linux*`
#        - smbclient -U $SMBLOGIN%$SMBPASS //$SMBNAME/darts-private-artifacts -c "put $wheel" -D=wheels_odls
#        - export wheel=`ls ./dist/*win*`
#        - smbclient -U $SMBLOGIN%$SMBPASS //$SMBNAME/darts-private-artifacts -c "put $wheel" -D=wheels_odls
#    dependencies:
#        # get the wheels from the build stage
#        - build-linux-3.10-ODLS
#        - build-windows-3.10-ODLS
        
###################################################################################

deploy-pypi:
    # Publish the release
    # Runs only for the main branch and if tag has a pattern: v#.#.#, for example "v1.2.3"
    rules: 
        - if: $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
    extends: .deploy-pypi
    variables:
        REPO: 'pypi'
        REPOUSER: $PYPIUSER
        REPOPWD: $PYPIPWD

deploy-testpypi:
    # Test publishing the release
    # Runs only manually, if variable UPLOAD_TEST_PYPI set to 1
    only:
        variables:
            - $UPLOAD_TEST_PYPI == "1"
    extends: .deploy-pypi
    variables:
        REPO: 'testpypi'
        REPOUSER: $TESTPYPIUSER
        REPOPWD: $TESTPYPIPWD

# pick all whl ODLS-artifacts (windows/linux, different python versions) and upload to test pipy
# TODO auto-increment package version (in setup.py and .gitlab-ci.yml) and add git tag; now it is done manually
.deploy-pypi:
    stage: deploy
    # just for twine
    image: python:3.10
    # Will be executed on runner with windows tag - that assumed to run on windows host
    tags:
        - linux
    before_script:
        # upgrade pip package first
        - python -m pip install --upgrade pip
        - pip install twine
    script:
        # upload to test-pypi or pypi depending on $PYPI var
        - ./helper_scripts/rename_whls.sh # rename linux whls to make uploadable to test-pypi
        - ls ./dist/*
        - twine upload -u $REPOUSER -p $REPOPWD --repository $REPO --verbose dist/*
    dependencies:
        # get the wheels from the build stage
        - build-linux-3.9-ODLS
        - build-linux-3.10-ODLS
        - build-linux-3.11-ODLS  
        - build-linux-3.12-ODLS
        - build-windows-3.9-ODLS
        - build-windows-3.10-ODLS
        - build-windows-3.11-ODLS
        - build-windows-3.12-ODLS
        
deploy-zenodo:
    stage: deploy
    rules:
        - if: $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
    tags:
        - linux
    image: python:3.10
    script:
        # cloning gitlab2zenodo in a temporary folder
        - mkdir tmp_gitlab2zenodo
        - cd tmp_gitlab2zenodo
        - git clone https://gitlab.com/sbeniamine/gitlab2zenodo.git
        - cd gitlab2zenodo
        # and installing gitlab2zenodo
        - pip install .
        - cd ../..
        # making a .zip containing the source files
        - git archive --format zip --output ${CI_COMMIT_TAG#v}.zip ${CI_COMMIT_TAG}
        # command that publishes to zenodo
        - g2z-send -p -m .zenodo.json ${CI_COMMIT_TAG#v}.zip

pages:
    stage: deploy
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $DOCS_PAGES == "1"
    tags:
        - linux
    image: python:3.10
    script:
        # re-install open-darts with the dependencies for building the documentation
        - pip install .[docs]
        # use the wheel generated in build to install open-darts
        - pip install --force-reinstall --no-deps ./dist/*cp310-linux_x86_64.whl
        - cd docs
        # command to build the documentation to a folder called public
        - sphinx-build -b html . public
        # move the folder public to the root of the project to be able to save it as artifact
        - mv public ../
    artifacts:
        paths:
        - public
    dependencies:
        - build-linux-3.10-ODLS
