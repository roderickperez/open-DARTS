valgrind-check:
    stage: test
    tags:
    - linux
    image: "python:$PY_VER"
    timeout: 4h
    variables:
        PY_VER: '3.10'
        PY_SUF: 'cp310-cp310'
    rules:
        - if: $TEST_VALGRIND == "1"
        # - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    needs:
        - build-linux-debug-3.10
    before_script:
        - export PATH="/opt/python/$PY_SUF/bin:$PATH"
        # install valgrind
        - apt-get update -qq && apt-get install -y -qq valgrind
        - export PYTHONUNBUFFERED=1
        - python -m pip install --upgrade pip
        - pip install setuptools
        # compute wheel name matching current Python/ABI/platform tag
        - export WHEEL_NAME=`python3 -c "from setuptools.dist import Distribution;from distutils.core import  Extension;dist = Distribution({'name':'open_darts_flash', 'version':'0.11.1', 'ext_modules':[Extension('mylib', ['mysrc.pyx', 'native.c'])]});bdist_wheel_cmd = dist.get_command_obj('bdist_wheel');print(bdist_wheel_cmd.wheel_dist_name + '-' + '-'.join(bdist_wheel_cmd.get_tag())+ '.whl');"`
        - ls ./dist/*
        # install the freshly built wheel with test extras (brings pytest)
        - pip install --force-reinstall --no-deps ./dist/$WHEEL_NAME[test]
        - pip install --upgrade --upgrade-strategy eager ./dist/$WHEEL_NAME[test]
        # ensure the local source tree doesn't shadow the installed package
        - rm -rf dartsflash
    script:
        # - cd build
        # - echo ">>> Running Valgrind check for darts-flash (ctest) <<<"
        # - valgrind --log-file=valgrind_logs/test_eos.out -v --leak-check=full ./build/tests/cpp/unit/darts-flash_test_eos
        # - valgrind --log-file=valgrind_logs/test_flash.out -v --leak-check=full ./build/tests/cpp/unit/darts-flash_test_flash
        # - valgrind --log-file=valgrind_logs/test_maths.out -v --leak-check=full ./build/tests/cpp/unit/darts-flash_test_maths
        # - valgrind --log-file=valgrind_logs/test_phflash.out -v --leak-check=full ./build/tests/cpp/unit/darts-flash_test_phflash
        # - valgrind --log-file=valgrind_logs/test_rr.out -v --leak-check=full ./build/tests/cpp/unit/darts-flash_test_rr
        # - valgrind --log-file=valgrind_logs/test_split.out -v --leak-check=full ./build/tests/cpp/unit/darts-flash_test_split
        # - valgrind --log-file=valgrind_logs/test_stability.out -v --leak-check=full ./build/tests/cpp/unit/darts-flash_test_stability
        - echo ">>> Running Valgrind check script for darts-flash (pytest) <<<"
        - python3 helper_scripts/valgrind_check.py pytest tests/python
    artifacts:
      paths:
        - valgrind_logs/*.log
        - valgrind_logs/*.txt
      when: always
      expire_in: 1 week


