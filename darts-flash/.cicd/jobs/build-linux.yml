
###################################################################################
     
.build-linux:
    stage: build
    image: ubuntu:18.04
    # Will be executed on runner with linux tag - that assumed to run on linux host
    tags:
        - linux
    variables:
        CONDA_ENV: "flash"
    before_script:
        - apt-get update && apt-get install -y --no-install-recommends ca-certificates wget bzip2 git build-essential libssl-dev
        # update cmake
        - wget -q https://github.com/Kitware/CMake/releases/download/v3.29.3/cmake-3.29.3.tar.gz && tar -xf cmake-3.29.3.tar.gz
        - cd cmake-3.29.3 && ./bootstrap --prefix=/opt/cmake --parallel=$(nproc) && make -j$(nproc) && make install && cd .. && export PATH=/opt/cmake/bin:${PATH}
        # install conda-forge
        - wget -q "https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-$(uname)-$(uname -m).sh"
        - bash Miniforge3-$(uname)-$(uname -m).sh -b -p /opt/conda
        # activate conda vars and path
        - source /opt/conda/bin/activate
        # create and activate a conda environment
        - conda create -n ${CONDA_ENV} python=${PY_VER} --yes
        - conda activate ${CONDA_ENV}
        - export PY_SUFFIX=`python3 -c "import importlib.machinery; print(importlib.machinery.EXTENSION_SUFFIXES[0])"`
        - python3 -m pip install --upgrade pip wheel build
    script:
        - ./helper_scripts/build.sh -s -w -j 8
    artifacts:
      paths:
        - './dist/*.whl'
        - './build/Testing/Temporary/LastTest.log'
      expire_in: 1 months
      when: always

###################################################################################

build-linux-3.14:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .build-linux
    variables:
        PY_VER: '3.14'       # for python image selection in .build-linux
        PY_SUF: 'cp314-cp314' # for python path selection in .build-linux

build-linux-3.13:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .build-linux
    variables:
        PY_VER: '3.13'       # for python image selection in .build-linux
        PY_SUF: 'cp313-cp313' # for python path selection in .build-linux


build-linux-3.12:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .build-linux
    variables:
        PY_VER: '3.12'       # for python image selection in .build-linux
        PY_SUF: 'cp312-cp312' # for python path selection in .build-linux

build-linux-3.11:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .build-linux
    variables:
        PY_VER: '3.11'       # for python image selection in .build-linux
        PY_SUF: 'cp311-cp311' # for python path selection in .build-linux

build-linux-3.10:
    rules:
        - if: $CI_COMMIT_REF_PROTECTED == "true"
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .build-linux
    variables:
        PY_VER: '3.10'       # for python image selection in .build-linux
        PY_SUF: 'cp310-cp310' # for python path selection in .build-linux
        
build-linux-debug-3.10:
    rules:
        - if: $TEST_VALGRIND == "1"
        # - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .build-linux
    variables:
        PY_VER: '3.10'
        PY_SUF: 'cp310-cp310'
    script:
        - ./helper_scripts/build.sh -s -t -w -j 8 -d Debug
    artifacts:
      paths:
        - './dist/*.whl'
        - './build/Testing/Temporary/LastTest.log'
        - './build/valgrind_logs/*'
      expire_in: 1 months
      when: always

build-linux-3.9: # for protected branches or merge requests
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .build-linux
    variables:
        PY_VER: '3.9'       # for python image selection in .build-linux
        PY_SUF: 'cp39-cp39' # for python path selection in .build-linux
        
build-linux-3.8:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .build-linux
    variables:
        PY_VER: '3.8'       # for python image selection in .build-linux
        PY_SUF: 'cp38-cp38' # for python path selection in .build-linux
