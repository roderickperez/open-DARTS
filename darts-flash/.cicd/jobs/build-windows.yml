.build-windows:
    stage: build
    # Will be executed on runner with windows shell tag - that assumed to run on windows host with shell executor
    tags: 
        - windows-shell
    variables:
        CONDA_ENV: "flash-win-${CI_JOB_ID}"
        CONDA_BIN_PATH: 'D:\miniconda3\condabin'        
    script:
        # Load MS Build Tools environment to the powershell
        - D:\\BuildTools\\build_vars.ps1
        - if (-not ($env:PATH.Split(';') -contains $env:CONDA_BIN_PATH)) { $env:PATH = "$env:CONDA_BIN_PATH;$env:PATH" }`
        - $condaRoot = Split-Path $env:CONDA_BIN_PATH -Parent
        - $condaHookPath = Join-Path $condaRoot 'shell\condabin\conda-hook.ps1'
        - if (Test-Path $condaHookPath) { (& $condaHookPath) | Out-Null }
        # Initialize conda environment
        - conda create --name $env:CONDA_ENV python=$env:PY_VER --yes -q
        - conda activate $env:CONDA_ENV        
        # Add python folder to PATH
        - $env:PATH += ";" + $env:PYTHONPATH + ";" + $env:PYTHONPATH + "\\Scripts"
        - $env:ARCH_SUF=python.exe -c "import importlib.machinery; print(importlib.machinery.EXTENSION_SUFFIXES[0].split('.')[1].split('-')[1])"
        - mkdir package
        - mkdir package\\dartsflash
        # copy VS redist libraries 
        - copy $env:VCToolsRedistDir\\x64\\Microsoft.VC143.CRT\\msvcp140.dll package\\dartsflash
        - copy $env:VCToolsRedistDir\\x64\\Microsoft.VC143.CRT\\vcruntime140.dll package\\dartsflash
        - copy $env:VCToolsRedistDir\\x64\\Microsoft.VC143.OpenMP\\vcomp140.dll package\\dartsflash
        # compile the libs and build the wheel
        - .\\helper_scripts\\build.bat -s -w -j 8
    after_script:
        - if (-not ($env:PATH.Split(';') -contains $env:CONDA_BIN_PATH)) { $env:PATH = "$env:CONDA_BIN_PATH;$env:PATH" }`
        - $condaRoot = Split-Path $env:CONDA_BIN_PATH -Parent
        - $condaHookPath = Join-Path $condaRoot 'shell\condabin\conda-hook.ps1'
        - if (Test-Path $condaHookPath) { (& $condaHookPath) | Out-Null }
        - conda deactivate
        - conda env remove --name $env:CONDA_ENV --yes
    artifacts:
      paths:
        - '.\\dist\\*.whl'
        - '.\\build\\Testing\\Temporary\\LastTest.log'
      expire_in: 1 months

###################################################################################

build-windows-3.14:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .build-windows
    variables:
        PY_VER: '3.14'
        PY_SUF: 'cp314-cp314'
        
build-windows-3.13:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .build-windows
    variables:
        PY_VER: '3.13'
        PY_SUF: 'cp313-cp313'        

build-windows-3.12:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .build-windows
    variables:
        PY_VER: '3.12'
        PY_SUF: 'cp312-cp312'

build-windows-3.11:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .build-windows
    variables:
        PY_VER: '3.11'      
        PY_SUF: 'cp311-cp311'

build-windows-3.10:
    rules:
        - if: $CI_COMMIT_REF_PROTECTED == "true"
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .build-windows
    variables:
        PY_VER: '3.10'       
        PY_SUF: 'cp310-cp310'
        
build-windows-3.9: # for protected branches or merge requests
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .build-windows
    variables:
        PY_VER: '3.9'      
        PY_SUF: 'cp39-cp39'
        
build-windows-3.8:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .build-windows
    variables:
        PY_VER: '3.8'
        PY_SUF: 'cp38-cp38'


