.test-windows:
    stage: test
    # Will be executed on runner with windows tag - that assumed to run on windows host
    tags:
        - windows-shell
    variables:
        CONDA_ENV: "flash-win-${CI_JOB_ID}"
        CONDA_BIN_PATH: 'D:\miniconda3\condabin'
    before_script:
        - if (-not ($env:PATH.Split(';') -contains $env:CONDA_BIN_PATH)) { $env:PATH = "$env:CONDA_BIN_PATH;$env:PATH" }`
        - $condaRoot = Split-Path $env:CONDA_BIN_PATH -Parent
        - $condaHookPath = Join-Path $condaRoot 'shell\condabin\conda-hook.ps1'
        - if (Test-Path $condaHookPath) { (& $condaHookPath) | Out-Null }
        # Initialize conda environment
        - conda create --name $env:CONDA_ENV python=$env:PY_VER --yes -q
        - conda activate $env:CONDA_ENV
        - $env:PATH += ";" + $env:PYTHONPATH + ";" + $env:PYTHONPATH + "\\Scripts"
        # enable unbuffered output so that everything goes to log file in a correct order
        - $env:PYTHONUNBUFFERED = 1
        - $env:PYTHONLEGACYWINDOWSSTDIO = 1
        # upgrade pip package first
        - python -m pip install --upgrade pip
        - pip install setuptools
        # complex command to create fake wheel and figure out the proper name for current python and platform
        - $env:WHEEL_NAME=python.exe -c "from setuptools.dist import Distribution;from distutils.core import  Extension;dist = Distribution({'name':'open_darts_flash', 'version':'0.11.1', 'ext_modules':[Extension('mylib', ['mysrc.pyx', 'native.c'])]});bdist_wheel_cmd = dist.get_command_obj('bdist_wheel');print(bdist_wheel_cmd.wheel_dist_name + '-' + '-'.join(bdist_wheel_cmd.get_tag())+ '.whl');"
        # force reinstall of wheel only (need to force because wheel version is not incremented)
        - pip install --force-reinstall --no-deps .\\dist\\$env:WHEEL_NAME[test]
        # force-reinstall of dependencies takes too much time, lets only upgrade (eagerly!) them
        - pip install --upgrade --upgrade-strategy eager .\\dist\\$env:WHEEL_NAME[test]
        # run pytest
        - pytest tests\\python
    script:
        - echo "test finished"
    after_script:
        - if (-not ($env:PATH.Split(';') -contains $env:CONDA_BIN_PATH)) { $env:PATH = "$env:CONDA_BIN_PATH;$env:PATH" }`
        - $condaRoot = Split-Path $env:CONDA_BIN_PATH -Parent
        - $condaHookPath = Join-Path $condaRoot 'shell\condabin\conda-hook.ps1'
        - if (Test-Path $condaHookPath) { (& $condaHookPath) | Out-Null }
        - conda deactivate
        - conda env remove --name $env:CONDA_ENV --yes
    #artifacts:
    #  paths:
    #    - '*.log'
    #  when: always
    #  expire_in: 1 year
    
###################################################################################

test-windows-3.14:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.14'
    needs:
        - build-windows-3.14

test-windows-3.13:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.13'
    needs:
        - build-windows-3.13

test-windows-3.12:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.12'
    needs:
        - build-windows-3.12

test-windows-3.11:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.11'
    needs:
        - build-windows-3.11
        
test-windows-3.10:
    rules:
        - if: $CI_COMMIT_REF_PROTECTED == "true"
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.10'
    needs:
        - build-windows-3.10

test-windows-3.9: # for protected branches or merge requests
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.9'
    needs:
        - build-windows-3.9
        
test-windows-3.8:
    rules:
        - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
        - if: $TEST_ALL == "1"
    extends: .test-windows
    variables:
        PY_VER: '3.8'
    needs:
        - build-windows-3.8
